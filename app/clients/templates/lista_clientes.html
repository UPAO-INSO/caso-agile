{% extends "base.html" %} {% block content %}
<div class="container mx-auto px-4 py-4 max-w-7xl">
  <!-- Header Section -->
  <div class="mb-5">
    <h1 class="text-3xl font-semibold text-gray-900 mb-2">Lista de Clientes</h1>
    <p class="text-sm text-gray-600">
      Gestión y consulta de clientes registrados
    </p>
  </div>

  <!-- Search Section -->
  <div class="bg-white rounded-xl p-6 mb-6 shadow-sm">
    <form method="GET" class="flex gap-3 items-end flex-wrap">
      <div class="flex-1 min-w-[250px]">
        <label for="dni" class="block text-sm font-medium text-gray-600 mb-1.5">
          Buscar por DNI
        </label>
        <input
          id="dni"
          name="dni"
          type="text"
          placeholder="Ingrese número de DNI..."
          value="{{ request.args.get('dni', '') }}"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
        />
      </div>
      <button
        type="submit"
        class="px-7 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition duration-200 cursor-pointer"
      >
        Buscar
      </button>
    </form>
  </div>

  <!-- Table Section -->
  <div class="bg-white rounded-xl overflow-hidden shadow-sm">
    <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
      <p class="text-sm text-gray-600">
        Total de clientes:
        <span class="font-semibold"
          >{{ clientes.total if clientes else 0 }}</span
        >
      </p>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead class="bg-gray-50">
          <tr>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              DNI
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              Nombre Completo
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              PEP
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              Fecha Registro
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              Monto Prestado
            </th>
            <th
              class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              Cuotas
            </th>
            <th
              class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200"
            >
              Estado
            </th>
          </tr>
        </thead>
        <tbody class="bg-white">
          {% for row in clientes.items %} {% set cliente = row[0] %} {% set
          monto_total = row[1] %} {% set total_prestamos = row[2] %} {% set
          total_cuotas = row[3] %} {% set prestamos_vigentes = row[4] %} {% set
          prestamos_morosos = row[5] %}
          <tr
            class="hover:bg-gray-50 transition-colors duration-150"
            data-cliente-id="{{ cliente.cliente_id }}"
          >
            <td
              class="px-6 py-4 text-sm font-semibold text-gray-900 border-b border-gray-100"
            >
              {{ cliente.dni }}
            </td>
            <td
              class="px-6 py-4 text-sm text-gray-700 border-b border-gray-100"
            >
              {{ cliente.nombre_completo }} {{ cliente.apellido_paterno }} {{
              cliente.apellido_materno }}
            </td>
            <td class="px-6 py-4 border-b border-gray-100">
              {% if cliente.pep %}
              <span
                class="inline-flex items-center gap-1.5 bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs font-semibold"
              >
                <span class="w-2 h-2 bg-red-600 rounded-full"></span>
                Si
              </span>
              {% else %}
              <span
                class="inline-flex items-center gap-1.5 bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-semibold"
              >
                <span class="w-2 h-2 bg-green-600 rounded-full"></span>
                No
              </span>
              {% endif %}
            </td>
            <td
              class="px-6 py-4 text-sm text-gray-600 border-b border-gray-100"
            >
              {{ cliente.fecha_registro.strftime('%d/%m/%Y') }}
            </td>
            <td
              class="px-6 py-4 text-sm font-semibold border-b border-gray-100"
            >
              {% if monto_total > 0 %}
              <span class="text-blue-600"
                >S/ {{ "%.2f"|format(monto_total) }}</span
              >
              <span class="text-xs text-gray-500 block mt-0.5"
                >{{ total_prestamos }} préstamo{{ 's' if total_prestamos != 1
                else '' }}</span
              >
              {% else %}
              <span class="text-gray-400">Sin préstamos</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-center border-b border-gray-100">
              {% if total_cuotas > 0 %}
              <span
                class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold"
              >
                {{ total_cuotas }}
              </span>
              {% else %}
              <span class="text-gray-400 text-xs">0</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-center border-b border-gray-100">
              <div class="flex items-center justify-center gap-2">
                {% if prestamos_vigentes > 0 %}
                <span
                  class="inline-flex items-center gap-1.5 bg-green-50 text-green-700 px-3 py-1.5 rounded-lg text-xs font-semibold"
                >
                  <span
                    class="w-2 h-2 bg-green-600 rounded-full animate-pulse"
                  ></span>
                  VIGENTE
                </span>
                {% elif total_prestamos > 0 %}
                <span
                  class="inline-flex items-center gap-1.5 bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-semibold"
                >
                  CANCELADO
                </span>
                {% else %}
                <span class="text-gray-400 text-xs">Sin prestamos</span>
                {% endif %} {% if total_prestamos > 0 %}
                <button
                  onclick="verDetallesPrestamos('{{ cliente.cliente_id }}')"
                  class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-medium transition-colors duration-200"
                  title="Ver detalles de prestamos"
                >
                  Ver Detalles
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td
              colspan="7"
              class="px-6 py-10 text-center text-gray-500 text-sm"
            >
              No se encontraron clientes con los criterios actuales.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex justify-center items-center gap-3">
    {% if clientes.has_prev %}
    <a
      href="{{ url_for('clientes.listar_clientes_view', page=clientes.prev_num, dni=request.args.get('dni', '')) }}"
      class="px-5 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 hover:border-blue-500 transition-all duration-200"
    >
      ← Anterior
    </a>
    {% endif %}

    <span
      class="px-5 py-2.5 bg-gray-50 rounded-lg text-sm text-gray-600 font-medium"
    >
      Página {{ clientes.page }} de {{ clientes.pages }}
    </span>

    {% if clientes.has_next %}
    <a
      href="{{ url_for('clientes.listar_clientes_view', page=clientes.next_num, dni=request.args.get('dni', '')) }}"
      class="px-5 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 hover:border-blue-500 transition-all duration-200"
    >
      Siguiente →
    </a>
    {% endif %}
  </div>
</div>

<!-- Modal de Detalles de Préstamos -->
<div
  id="modalDetallesPrestamos"
  class="fixed inset-0 bg-gray-700/70 bg-opacity-50 hidden items-center justify-center z-50"
  style="display: none"
>
  <div
    class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden"
  >
    <!-- Header del Modal -->
    <div
      class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center"
    >
      <h2 class="text-xl font-bold text-white">Detalles de Préstamos</h2>
      <button
        onclick="cerrarModal()"
        class="text-white hover:text-gray-200 transition-colors"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Contenido del Modal -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
      <!-- Información del Cliente -->
      <div id="modalClienteInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="bg-blue-100 rounded-full p-3">
            <svg
              class="w-8 h-8 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </div>
          <div>
            <h3
              id="modalClienteNombre"
              class="text-lg font-semibold text-gray-900"
            >
              Cargando...
            </h3>
            <p id="modalClienteDni" class="text-sm text-gray-600">DNI: ---</p>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="modalLoading" class="text-center py-8">
        <div
          class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"
        ></div>
        <p class="mt-4 text-gray-600">Cargando información...</p>
      </div>

      <!-- Contenido de Préstamos -->
      <div id="modalPrestamosContent" class="hidden">
        <!-- Se llenará dinámicamente con JavaScript -->
      </div>

      <!-- Error -->
      <div id="modalError" class="hidden text-center py-8">
        <svg
          class="w-16 h-16 text-red-500 mx-auto mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <p class="text-red-600 font-semibold">Error al cargar los datos</p>
        <p id="modalErrorMsg" class="text-gray-600 mt-2"></p>
      </div>
    </div>
  </div>
</div>

<script>
  // Función para abrir el modal y cargar detalles de préstamos
  async function verDetallesPrestamos(clienteId) {
    const modal = document.getElementById("modalDetallesPrestamos");
    const loading = document.getElementById("modalLoading");
    const content = document.getElementById("modalPrestamosContent");
    const error = document.getElementById("modalError");

    // Mostrar modal y loading
    modal.style.display = "flex";
    loading.classList.remove("hidden");
    content.classList.add("hidden");
    error.classList.add("hidden");

    try {
      // Obtener datos del cliente
      const clienteResponse = await fetch(`/api/v1/clientes/${clienteId}`);
      if (!clienteResponse.ok) throw new Error("Cliente no encontrado");

      const cliente = await clienteResponse.json();

      // Actualizar info del cliente en el modal
      document.getElementById(
        "modalClienteNombre"
      ).textContent = `${cliente.nombre_completo} ${cliente.apellido_paterno} ${cliente.apellido_materno}`;
      document.getElementById(
        "modalClienteDni"
      ).textContent = `DNI: ${cliente.dni}`;

      // Obtener préstamos del cliente (necesitamos crear un endpoint JSON)
      const prestamosResponse = await fetch(
        `/api/v1/prestamos/cliente/${clienteId}/json`
      );

      if (!prestamosResponse.ok) {
        // Si no existe el endpoint, mostrar mensaje
        throw new Error(
          "No se pudo cargar los préstamos. Endpoint no disponible."
        );
      }

      const prestamos = await prestamosResponse.json();

      // Construir HTML de préstamos
      let html = "";

      if (prestamos.length === 0) {
        html = `
        <div class="text-center py-8 text-gray-500">
          <p>Este cliente no tiene préstamos registrados</p>
        </div>
      `;
      } else {
        prestamos.forEach((prestamo, index) => {
          // Definir colores segun estado
          let estadoClass = "";
          if (prestamo.estado === "VIGENTE") {
            estadoClass = "bg-green-100 text-green-800";
          } else if (prestamo.estado === "CANCELADO") {
            estadoClass = "bg-gray-100 text-gray-800";
          }

          // Definir opciones del select segun el estado actual
          let opcionesEstado = "";
          if (prestamo.estado === "VIGENTE") {
            opcionesEstado = `
            <option value="">Cambiar estado...</option>
            <option value="CANCELADO">CANCELADO</option>
          `;
          } else if (prestamo.estado === "CANCELADO") {
            opcionesEstado = `
            <option value="" selected>No se puede cambiar</option>
          `;
          }

          html += `
          <div class="border border-gray-200 rounded-lg p-5 mb-4 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="text-lg font-semibold text-gray-900">Préstamo #${
                  prestamo.prestamo_id
                }</h4>
                <p class="text-sm text-gray-600">Otorgado: ${
                  prestamo.f_otorgamiento
                }</p>
              </div>
              <div class="flex gap-2 items-center">
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${estadoClass}">
                  ${prestamo.estado}
                </span>
                <select 
                  onchange="cambiarEstadoPrestamo(${
                    prestamo.prestamo_id
                  }, this.value, '${prestamo.estado}')"
                  class="px-3 py-1 border border-gray-300 rounded-lg text-xs font-medium bg-white hover:bg-gray-50 transition-colors cursor-pointer ${
                    prestamo.estado === "CANCELADO"
                      ? "opacity-50 cursor-not-allowed"
                      : ""
                  }"
                  ${prestamo.estado === "CANCELADO" ? "disabled" : ""}
                >
                  ${opcionesEstado}
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div>
                <p class="text-xs text-gray-600">Monto Total</p>
                <p class="text-lg font-bold text-blue-600">S/ ${parseFloat(
                  prestamo.monto_total
                ).toFixed(2)}</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">Interés TEA</p>
                <p class="text-lg font-semibold text-gray-900">${parseFloat(
                  prestamo.interes_tea
                ).toFixed(2)}%</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">Plazo</p>
                <p class="text-lg font-semibold text-gray-900">${
                  prestamo.plazo
                } meses</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">Declaración Jurada</p>
                <p class="text-sm font-semibold ${
                  prestamo.requiere_dec_jurada
                    ? "text-red-600"
                    : "text-green-600"
                }">
                  ${prestamo.requiere_dec_jurada ? "Requerida" : "No requerida"}
                </p>
              </div>
            </div>
            
            ${
              prestamo.cronograma && prestamo.cronograma.length > 0
                ? `
              <div class="mt-4">
                <button 
                  onclick="toggleCronograma(${index})"
                  class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors flex items-center justify-between"
                >
                  <span>Ver Cronograma de Pagos (${
                    prestamo.cronograma.length
                  } cuotas)</span>
                  <svg id="cronograma-icon-${index}" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                
                <div id="cronograma-${index}" class="hidden mt-3 overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Cuota</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Vencimiento</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600">Monto</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600">Capital</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600">Interés</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600">Saldo</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      ${prestamo.cronograma
                        .map(
                          (cuota) => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-3 py-2 text-gray-900 font-medium">${
                            cuota.numero_cuota
                          }</td>
                          <td class="px-3 py-2 text-gray-600">${
                            cuota.fecha_vencimiento
                          }</td>
                          <td class="px-3 py-2 text-right font-semibold text-gray-900">S/ ${parseFloat(
                            cuota.monto_cuota
                          ).toFixed(2)}</td>
                          <td class="px-3 py-2 text-right text-gray-600">S/ ${parseFloat(
                            cuota.monto_capital
                          ).toFixed(2)}</td>
                          <td class="px-3 py-2 text-right text-gray-600">S/ ${parseFloat(
                            cuota.monto_interes
                          ).toFixed(2)}</td>
                          <td class="px-3 py-2 text-right text-blue-600 font-medium">S/ ${parseFloat(
                            cuota.saldo_capital
                          ).toFixed(2)}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
              </div>
            `
                : ""
            }
          </div>
        `;
        });
      }

      content.innerHTML = html;
      loading.classList.add("hidden");
      content.classList.remove("hidden");
    } catch (err) {
      loading.classList.add("hidden");
      error.classList.remove("hidden");
      document.getElementById("modalErrorMsg").textContent = err.message;
    }
  }

  // Función para cerrar el modal
  function cerrarModal() {
    document.getElementById("modalDetallesPrestamos").style.display = "none";
  }

  // Función para mostrar/ocultar cronograma
  function toggleCronograma(index) {
    const cronograma = document.getElementById(`cronograma-${index}`);
    const icon = document.getElementById(`cronograma-icon-${index}`);

    if (cronograma.classList.contains("hidden")) {
      cronograma.classList.remove("hidden");
      icon.style.transform = "rotate(180deg)";
    } else {
      cronograma.classList.add("hidden");
      icon.style.transform = "rotate(0deg)";
    }
  }

  // Función para cambiar estado del préstamo
  async function cambiarEstadoPrestamo(prestamoId, nuevoEstado, estadoActual) {
    if (!nuevoEstado) return;

    // Validaciones del lado del cliente
    if (estadoActual === "CANCELADO") {
      alert("Un préstamo CANCELADO no puede cambiar de estado.");
      event.target.value = "";
      return;
    }

    // Mensaje personalizado segun la transicion
    let mensaje = `¿Esta seguro de cambiar el estado del prestamo de ${estadoActual} a ${nuevoEstado}?`;

    if (nuevoEstado === "CANCELADO") {
      mensaje +=
        "\n\nADVERTENCIA: Esta accion es IRREVERSIBLE. Un prestamo CANCELADO no podra cambiar de estado nuevamente.";
    }

    if (!confirm(mensaje)) {
      event.target.value = "";
      return;
    }

    try {
      const response = await fetch(
        `/api/v1/prestamos/actualizar-estado/${prestamoId}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ estado: nuevoEstado }),
        }
      );

      const data = await response.json();

      if (response.ok) {
        alert(`EXITO: ${data.mensaje}`);
        location.reload();
      } else {
        alert(`ERROR: ${data.error}`);
        event.target.value = "";
      }
    } catch (err) {
      alert("ERROR de conexion: " + err.message);
      event.target.value = "";
    }
  }

  // Cerrar modal al hacer clic fuera
  document
    .getElementById("modalDetallesPrestamos")
    ?.addEventListener("click", function (e) {
      if (e.target === this) {
        cerrarModal();
      }
    });
</script>

{% endblock %}
