{% extends "base.html" %} 

{% block content %}
<style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    input[type="radio"]:checked+label { border-color: #137fec; background-color: #137fec1a; color: #137fec; }
    input[type="radio"]:checked+label .icon-container { color: #137fec; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    #card-form-container { transition: all 0.3s ease-in-out; }
    
    /* Animación de entrada para el éxito */
    .fade-in-up { animation: fadeInUp 0.5s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-5xl mx-auto mt-6">
    
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('prestamos_view.index_view') }}" class="text-blue-600 hover:text-blue-800">Inicio</a></li>
            <li class="text-gray-400">/</li>
            <li><a href="{{ url_for('prestamos_view.ver_prestamo_view', prestamo_id=prestamo.prestamo_id) }}" class="text-blue-600 hover:text-blue-800">Préstamo #{{ prestamo.prestamo_id }}</a></li>
            <li class="text-gray-400">/</li>
            <li class="text-gray-600">Registrar Pago</li>
        </ol>
    </nav>

    {% if success %}
    
    <div class="flex flex-col items-center justify-center py-12 fade-in-up">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center border border-green-100">
            
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
                <i class="fa-solid fa-check text-4xl text-green-600"></i>
            </div>
            
            <h2 class="text-3xl font-bold text-gray-900 mb-2">¡Pago Registrado!</h2>
            <p class="text-gray-500 mb-4">El pago de <span class="font-bold text-gray-800">S/ {{ "{:,.2f}".format(datos_pago.monto|float) }}</span> ha sido procesado correctamente.</p>
            
            {% if datos_pago.redondeo and datos_pago.metodo == 'EFECTIVO' %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-left">
                <p class="text-xs font-semibold text-blue-800 mb-2">
                    <i class="fa-solid fa-info-circle mr-1"></i> Redondeo aplicado (Ley N° 29571)
                </p>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                        <p class="text-gray-600">Deuda real:</p>
                        <p class="font-bold text-gray-900">S/ {{ "{:,.2f}".format(datos_pago.redondeo.monto_contable) }}</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Cliente pagó:</p>
                        <p class="font-bold {% if datos_pago.redondeo.ajuste_redondeo < 0 %}text-green-700{% else %}text-blue-700{% endif %}">S/ {{ "{:,.2f}".format(datos_pago.redondeo.monto_pagado_cliente) }}</p>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-blue-200">
                    <p class="text-xs {% if datos_pago.redondeo.ajuste_redondeo < 0 %}text-green-700{% else %}text-blue-700{% endif %}">
                        {{ datos_pago.redondeo.mensaje }}
                    </p>
                </div>
            </div>
            {% endif %}
            
            <div class="space-y-3">
                <button onclick="alert('Funcionalidad de PDF pendiente de implementar')" 
                        class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 md:text-lg transition-colors shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-file-invoice-dollar mr-2"></i> Emitir Comprobante
                </button>

                {% set client_email = prestamo.cliente.correo_electronico or 'No tiene correo' %}
                    <button onclick="alert('Se enviará el correo a: {{ client_email }}')" 
                            class="w-full flex items-center justify-center px-4 py-3 border-2 border-blue-600 text-base font-medium rounded-lg text-blue-600 bg-transparent hover:bg-blue-50 md:text-lg transition-colors">
                        <i class="fa-solid fa-envelope mr-2"></i> Enviar comprobante a {{ client_email }}
                    </button>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <a href="{{ url_for('prestamos_view.ver_prestamo_view', prestamo_id=prestamo.prestamo_id) }}" 
                   class="text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Volver al detalle del préstamo
                </a>
            </div>
        </div>
    </div>

    {% else %}

    <div class="flex flex-col gap-8">
        <div class="flex flex-col gap-2">
            <h1 class="text-3xl font-bold text-gray-900"><i class="fa-solid fa-money-bill-transfer mr-2"></i> Registrar Pago</h1>
            <p class="text-gray-600">Ingrese los detalles a continuación para registrar un nuevo pago.</p>
        </div>

        <form method="POST" id="form-pago" class="flex flex-col gap-8">
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Información del Préstamo</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div><p class="text-sm text-gray-500">Cliente</p><p class="text-lg font-medium text-gray-900">{{ prestamo.cliente.nombre_completo }}</p></div>
                    <div><p class="text-sm text-gray-500">Saldo Total Pendiente</p><p class="text-lg font-bold text-red-600">S/ {{ "{:,.2f}".format(resumen.total_pendiente) }}</p></div>
                    <div><p class="text-sm text-gray-500">ID Préstamo</p><p class="text-gray-900 font-medium">#{{ prestamo.prestamo_id }}</p></div>
                    <div><p class="text-sm text-gray-500">Estado</p><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">{{ prestamo.estado.value }}</span></div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Detalles del Pago</h2>
                <div class="flex flex-col gap-6">
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-6">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Fecha del Pago</label>
                            <input class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" type="date" name="fecha_pago" value="{{ hoy }}"/>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Hora del Pago</label>
                            <input id="input_hora" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" type="time" name="hora_pago" required/>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Cuota a Pagar</label>
                            <select id="select_cuota" name="numero_cuota" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                {% set ns = namespace(found=false) %}
                                {% for cuota in cuotas %}
                                    {% if cuota.saldo_pendiente > 0.01 %}
                                        {% if not ns.found %}
                                            <option value="{{ cuota.numero_cuota }}" data-saldo="{{ cuota.saldo_pendiente }}" data-mora="{{ cuota.mora_acumulada }}" selected>
                                                Cuota {{ cuota.numero_cuota }} (Vence: {{ cuota.fecha_vencimiento.strftime('%d/%m/%Y') }}) - Saldo: S/ {{ "{:,.2f}".format(cuota.saldo_pendiente) }}{% if cuota.mora_acumulada > 0 %} + Mora: S/ {{ "{:,.2f}".format(cuota.mora_acumulada) }}{% endif %}
                                            </option>
                                            {% set ns.found = true %}
                                        {% else %}
                                            <option value="{{ cuota.numero_cuota }}" data-saldo="{{ cuota.saldo_pendiente }}" data-mora="{{ cuota.mora_acumulada }}">
                                                Cuota {{ cuota.numero_cuota }} (Vence: {{ cuota.fecha_vencimiento.strftime('%d/%m/%Y') }}) - Saldo: S/ {{ "{:,.2f}".format(cuota.saldo_pendiente) }}{% if cuota.mora_acumulada > 0 %} + Mora: S/ {{ "{:,.2f}".format(cuota.mora_acumulada) }}{% endif %}
                                            </option>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if not ns.found %}<option value="" disabled selected>¡Todo pagado!</option>{% endif %}
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Monto a Pagar S/</label>
                            <div class="relative">
                                <input id="input_monto" name="monto_pagado" type="number" step="0.01" min="0.10" class="w-full rounded-lg border border-gray-300 pl-8 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="0.00" required />
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                <span id="redondeo_text">Para efectivo: pagos parciales en múltiplos de S/ 0.10</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Monto Dado (solo para EFECTIVO) -->
                    <div id="monto_dado_container" class="grid grid-cols-1 sm:grid-cols-1 gap-6">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Monto Dado (Billetes entregados) S/</label>
                            <div class="relative">
                                <input id="input_monto_dado" name="monto_dado" type="number" step="0.10" min="0" class="w-full rounded-lg border border-gray-300 pl-8 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="0.00" />
                            </div>
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fa-solid fa-hand-holding-dollar mr-1"></i>
                                Ingrese la cantidad de billetes que el cliente entrega (debe ser mayor o igual al monto a pagar)
                            </p>
                        </div>
                    </div>

                    <!-- Alerta de Mora (si existe) -->
                    {% set primera_cuota_pendiente = cuotas|selectattr('saldo_pendiente', 'gt', 0)|first %}
                    {% if primera_cuota_pendiente and primera_cuota_pendiente.mora_acumulada > 0 %}
                    <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-exclamation-triangle text-red-600 text-xl mt-0.5"></i>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-red-800 mb-1">Mora Pendiente</h4>
                                <p class="text-sm text-red-700 mb-2">
                                    La cuota {{ primera_cuota_pendiente.numero_cuota }} tiene mora acumulada de 
                                    <span class="font-bold">S/ {{ "{:,.2f}".format(primera_cuota_pendiente.mora_acumulada) }}</span>
                                </p>
                                <p class="text-xs text-red-600">
                                    <i class="fa-solid fa-info-circle mr-1"></i>
                                    La mora se cobrará automáticamente al procesar el pago (1% mensual)
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Método de Pago</label>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="relative"><input checked class="sr-only payment-method-radio" id="cash" name="metodo_pago" type="radio" value="EFECTIVO"/><label class="flex flex-col items-center justify-center p-4 text-center border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" for="cash"><i class="fa-solid fa-money-bill-1 text-2xl mb-1 text-gray-500 icon-container"></i><span class="text-sm font-medium text-gray-600">Efectivo</span></label></div>
                            <div class="relative"><input class="sr-only payment-method-radio" id="card" name="metodo_pago" type="radio" value="TARJETA_CREDITO"/><label class="flex flex-col items-center justify-center p-4 text-center border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" for="card"><i class="fa-solid fa-credit-card text-2xl mb-1 text-gray-500 icon-container"></i><span class="text-sm font-medium text-gray-600">Tarjeta</span></label></div>
                            <div class="relative"><input class="sr-only payment-method-radio" id="transfer" name="metodo_pago" type="radio" value="TRANSFERENCIA"/><label class="flex flex-col items-center justify-center p-4 text-center border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" for="transfer"><i class="fa-solid fa-building-columns text-2xl mb-1 text-gray-500 icon-container"></i><span class="text-sm font-medium text-gray-600">Transf.</span></label></div>
                            <div class="relative"><input class="sr-only payment-method-radio" id="wallet" name="metodo_pago" type="radio" value="YAPE"/><label class="flex flex-col items-center justify-center p-4 text-center border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" for="wallet"><i class="fa-solid fa-qrcode text-2xl mb-1 text-gray-500 icon-container"></i><span class="text-sm font-medium text-gray-600">Yape/Plin</span></label></div>
                        </div>
                    </div>

                    <div id="card-form-container" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-2">
                        <div class="flex items-center mb-4 text-blue-800"><i class="fa-brands fa-cc-visa text-2xl mr-2"></i><i class="fa-brands fa-cc-mastercard text-2xl mr-2"></i><span class="text-sm font-medium">Ingrese los datos de la tarjeta</span></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2"><label class="block text-xs font-medium text-gray-700 mb-1">Número de Tarjeta</label><div class="relative"><input type="text" id="card_number" name="card_number" placeholder="0000 0000 0000 0000" maxlength="19" class="w-full rounded-lg border border-gray-300 pl-10 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fa-regular fa-credit-card text-gray-400"></i></div></div></div>
                            <div class="col-span-1 md:col-span-2"><label class="block text-xs font-medium text-gray-700 mb-1">Nombre del Titular</label><input type="text" id="card_holder" name="card_holder" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 uppercase"></div>
                            <div><label class="block text-xs font-medium text-gray-700 mb-1">Vencimiento (MM/YY)</label><div class="relative"><input type="text" id="card_expiry" name="card_expiry" placeholder="MM/YY" maxlength="5" class="w-full rounded-lg border border-gray-300 pl-10 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fa-regular fa-calendar text-gray-400"></i></div></div></div>
                            <div><label class="block text-xs font-medium text-gray-700 mb-1">CVV</label><div class="relative"><input type="password" id="card_cvv" name="card_cvv" placeholder="123" maxlength="4" class="w-full rounded-lg border border-gray-300 pl-10 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fa-solid fa-lock text-gray-400"></i></div></div></div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-600 rounded-r-lg p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Resumen del Pago</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Monto Ingresado (Monto Dado para efectivo) -->
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-700" id="label_monto_ingresado">Monto Ingresado</p>
                                <p class="text-2xl font-bold text-blue-800" id="display_monto_ingresado">S/ 0.00</p>
                            </div>
                            <div class="border-t border-blue-300"></div>
                            
                            <!-- Monto a Pagar (lo que quiere pagar) -->
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-700">Monto a Pagar</p>
                                <p class="text-2xl font-bold text-gray-800" id="display_monto_a_pagar">S/ 0.00</p>
                            </div>
                            <div class="border-t border-blue-300"></div>
                            
                            <!-- Monto de la Cuota (redondeado para efectivo en pago completo) -->
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-700">Monto de la Cuota</p>
                                <p class="text-2xl font-bold text-purple-800" id="display_monto_cuota">S/ 0.00</p>
                            </div>
                            
                            <!-- Ajuste/Condonación (solo para efectivo en pago completo) -->
                            <div id="ajuste_container" class="hidden">
                                <div class="border-t border-blue-300"></div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-700" id="ajuste_label">Ajuste/Condonación</p>
                                    <p class="text-2xl font-bold" id="display_ajuste">S/ 0.00</p>
                                </div>
                            </div>
                            
                            <div class="border-t border-blue-300"></div>
                            
                            <!-- Saldo Restante (Cuota - Monto a pagar) -->
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-700">Saldo Restante</p>
                                <p class="text-2xl font-bold text-red-600" id="display_saldo_restante">S/ 0.00</p>
                            </div>
                            
                            <!-- Vuelto (Monto dado - Monto a pagar) -->
                            <div id="vuelto_container" class="hidden">
                                <div class="border-t border-blue-300"></div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-700">Vuelto</p>
                                    <p class="text-2xl font-bold text-green-700" id="display_vuelto">S/ 0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mb-10">
                <a href="{{ url_for('prestamos_view.ver_prestamo_view', prestamo_id=prestamo.prestamo_id) }}" class="flex items-center justify-center rounded-lg h-11 bg-white border border-gray-300 text-gray-700 gap-2 text-sm font-bold px-6 hover:bg-gray-50 transition-colors">Cancelar</a>
                <button type="submit" id="btn-submit" class="flex items-center justify-center rounded-lg h-11 bg-blue-600 text-white gap-2 text-sm font-bold px-6 hover:bg-blue-700 transition-colors shadow-lg">
                    <i class="fa-regular fa-paper-plane" id="btn-icon"></i> <span id="btn-text">Registrar Pago</span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // Variable global para almacenar si la caja está cerrada
        let cajaCerrada = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si la caja está cerrada usando el estado global
            verificarYRestaurarEstadoCaja();
            
            const selectCuota = document.getElementById('select_cuota');
            const inputMonto = document.getElementById('input_monto');
            const inputMontoDado = document.getElementById('input_monto_dado');
            const inputHora = document.getElementById('input_hora');
            const montoDadoContainer = document.getElementById('monto_dado_container');
            const redondeoText = document.getElementById('redondeo_text');
            const paymentRadios = document.querySelectorAll('.payment-method-radio');
            const cardContainer = document.getElementById('card-form-container');
            const cardInputs = cardContainer ? cardContainer.querySelectorAll('input') : [];
            const btnSubmitText = document.getElementById('btn-text');
            const btnSubmitIcon = document.getElementById('btn-icon');

            const labelMontoIngresado = document.getElementById('label_monto_ingresado');
            const displayMontoIngresado = document.getElementById('display_monto_ingresado');
            const displayMontoAPagar = document.getElementById('display_monto_a_pagar');
            const displayMontoCuota = document.getElementById('display_monto_cuota');
            const ajusteContainer = document.getElementById('ajuste_container');
            const ajusteLabel = document.getElementById('ajuste_label');
            const displayAjuste = document.getElementById('display_ajuste');
            const vueltoContainer = document.getElementById('vuelto_container');
            const displayVuelto = document.getElementById('display_vuelto');
            const displaySaldoRestante = document.getElementById('display_saldo_restante');

            let currentPaymentMethod = 'EFECTIVO';
            let montoTotalCuota = 0; // Monto total de la cuota (saldo + mora)
            
            // Establecer hora actual
            if (inputHora) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                inputHora.value = `${hours}:${minutes}`;
            }

            function actualizarInputConCuota() {
                const selectedOption = selectCuota.options[selectCuota.selectedIndex];
                if (!selectedOption || selectedOption.disabled) return;
                
                const saldoPendiente = parseFloat(selectedOption.getAttribute('data-saldo')) || 0;
                const moraAcumulada = parseFloat(selectedOption.getAttribute('data-mora')) || 0;
                const totalAPagar = saldoPendiente + moraAcumulada;
                
                montoTotalCuota = totalAPagar; // Guardar el monto total
                // Establecer límites pero no sobreescribir la entrada si el usuario ya la editó
                // Límite máximo = monto de la cuota, excepto para EFECTIVO (permitir pago mayor para dar vuelto)
                if (currentPaymentMethod !== 'EFECTIVO') {
                    inputMonto.max = totalAPagar.toFixed(2);
                } else {
                    inputMonto.removeAttribute('max');
                }
                inputMonto.min = '0.10';
                // Si el usuario NO ha editado manualmente el campo, inicializarlo
                if (!inputMonto.dataset.userEdited) {
                    // Solo inicializar si está vacío o es 0
                    if (!inputMonto.value || parseFloat(inputMonto.value) === 0) {
                        inputMonto.value = totalAPagar.toFixed(2);
                    }
                }
                actualizarDisplays();
            }

            // Nueva función: actualiza los valores visibles según nueva lógica
            async function actualizarDisplays() {
                const montoAPagar = parseFloat(inputMonto.value) || 0;
                const montoDado = parseFloat(inputMontoDado.value) || 0;
                const esEfectivo = currentPaymentMethod === 'EFECTIVO';
                const esPagoCompleto = Math.abs(montoAPagar - montoTotalCuota) < 0.01;
                
                const fmt = v => 'S/ ' + Number(v || 0).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
                
                // Monto Ingresado
                if (esEfectivo) {
                    labelMontoIngresado.textContent = 'Monto Ingresado (Billetes)';
                    displayMontoIngresado.textContent = fmt(montoDado);
                } else {
                    labelMontoIngresado.textContent = 'Monto Ingresado';
                    displayMontoIngresado.textContent = fmt(montoAPagar);
                }
                
                // Monto a Pagar (lo que quiere pagar)
                displayMontoAPagar.textContent = fmt(montoAPagar);
                
                // Monto de la Cuota + Ajuste/Condonación
                if (esEfectivo && esPagoCompleto && montoTotalCuota > 0) {
                    // Llamar al BACKEND para obtener el cálculo del redondeo
                    const datosRedondeo = await calcularRedondeo(montoTotalCuota, 'EFECTIVO');
                    
                    if (datosRedondeo && datosRedondeo.success && Math.abs(datosRedondeo.ajuste_redondeo) > 0.001) {
                        // Mostrar cuota redondeada
                        displayMontoCuota.textContent = fmt(datosRedondeo.monto_redondeado);
                        
                        // Mostrar ajuste/condonación
                        ajusteContainer.classList.remove('hidden');
                        const esCondonacion = datosRedondeo.ajuste_redondeo < 0;
                        ajusteLabel.textContent = esCondonacion ? 'Condonación' : 'Ajuste';
                        displayAjuste.textContent = fmt(Math.abs(datosRedondeo.ajuste_redondeo));
                        displayAjuste.className = esCondonacion ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-blue-600';
                    } else {
                        // Sin ajuste
                        displayMontoCuota.textContent = fmt(montoTotalCuota);
                        ajusteContainer.classList.add('hidden');
                    }
                } else {
                    // Pago parcial o no efectivo: mostrar cuota sin redondeo
                    displayMontoCuota.textContent = fmt(montoTotalCuota);
                    ajusteContainer.classList.add('hidden');
                }
                
                // Saldo Restante (Cuota - Monto a pagar)
                let saldoRestante = montoTotalCuota - montoAPagar;
                if (saldoRestante < 0) saldoRestante = 0;
                displaySaldoRestante.textContent = fmt(saldoRestante);
                
                // Vuelto (Monto dado - Monto a pagar) - solo para efectivo
                if (esEfectivo && montoDado > 0) {
                    const vuelto = montoDado - montoAPagar;
                    if (vuelto > 0.001) {
                        vueltoContainer.classList.remove('hidden');
                        displayVuelto.textContent = fmt(vuelto);
                    } else {
                        vueltoContainer.classList.add('hidden');
                    }
                } else {
                    vueltoContainer.classList.add('hidden');
                }
            }

            // Validar entrada manual: forzar redondeo en pagos parciales
            function validarInputManual(event) {
                let valor = parseFloat(inputMonto.value) || 0;
                
                // No permitir valores mayores a la cuota
                if (valor > montoTotalCuota) {
                    valor = montoTotalCuota;
                    inputMonto.value = valor.toFixed(2);
                }
                
                // Si es el monto EXACTO del cronograma, permitir decimales
                const esPagoCompleto = Math.abs(valor - montoTotalCuota) < 0.01;
                
                if (!esPagoCompleto) {
                    // PAGO PARCIAL: FORZAR redondeo a múltiplos de 0.10
                    const centavos = Math.round(valor * 100) % 10;
                    if (centavos !== 0) {
                        let valorRedondeado = Math.round(valor * 10) / 10;
                        if (valorRedondeado > montoTotalCuota) {
                            valorRedondeado = Math.floor(valor * 10) / 10;
                        }
                        valor = valorRedondeado;
                        inputMonto.value = valor.toFixed(2);
                    }
                }
                
                actualizarDisplays();
            }
            
            // Validar monto dado con denominaciones válidas
            function validarMontoDado() {
                if (currentPaymentMethod !== 'EFECTIVO') return;
                
                const montoDado = parseFloat(inputMontoDado.value) || 0;
                const montoAPagar = parseFloat(inputMonto.value) || 0;
                
                if (montoDado > 0 && montoDado < montoAPagar) {
                    inputMontoDado.setCustomValidity('El monto dado debe ser mayor o igual al monto a pagar');
                } else if (montoDado - montoAPagar > 200) {
                    inputMontoDado.setCustomValidity('La diferencia no puede ser mayor a S/ 200.00');
                } else {
                    inputMontoDado.setCustomValidity('');
                }
            }

            async function calcularRedondeo(monto, medioPago) {
                try {
                    const response = await fetch('/prestamos/api/calcular-redondeo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            monto: monto,
                            medio_pago: medioPago
                        })
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error('Error calculando redondeo:', error);
                    return null;
                }
            }



            function actualizarMetodoPago(metodo) {
                currentPaymentMethod = metodo;
                
                if (metodo === 'EFECTIVO') {
                    redondeoText.textContent = 'Para efectivo: pagos parciales en múltiplos de S/ 0.10';
                    montoDadoContainer.classList.remove('hidden');
                    inputMontoDado.required = true;
                } else {
                    redondeoText.textContent = 'Puede ingresar cualquier monto con centavos';
                    montoDadoContainer.classList.add('hidden');
                    inputMontoDado.required = false;
                    inputMontoDado.value = '';
                    // No forzar el restablecimiento del campo si el usuario ya lo editó
                    if (!inputMonto.dataset.userEdited && montoTotalCuota > 0) {
                        inputMonto.value = montoTotalCuota.toFixed(2);
                        actualizarDisplays();
                    }
                }
                
                actualizarDisplays();
            }

            if(selectCuota) {
                selectCuota.addEventListener('change', actualizarInputConCuota);
                // Marcar que el usuario editó el campo cuando escribe y actualizar displays
                inputMonto.addEventListener('input', function(e){
                    this.dataset.userEdited = '1';
                    actualizarDisplays();
                });
                
                // Event listener para monto dado
                if (inputMontoDado) {
                    inputMontoDado.addEventListener('input', function() {
                        validarMontoDado();
                        actualizarDisplays();
                    });
                    inputMontoDado.addEventListener('blur', validarInputManual);
                }
                
                // Validar monto a pagar al escribir
                inputMonto.addEventListener('blur', validarInputManual);
                
                // Validación y envío al backend
                const form = document.getElementById('form-pago');
                if (form) {
                    form.addEventListener('submit', async function(e){
                        e.preventDefault();
                        
                        // Validar que monto dado >= monto a pagar para efectivo
                        if (currentPaymentMethod === 'EFECTIVO') {
                            const montoDado = parseFloat(inputMontoDado.value) || 0;
                            const montoAPagar = parseFloat(inputMonto.value) || 0;
                            if (montoDado < montoAPagar) {
                                alert('El monto dado debe ser mayor o igual al monto a pagar');
                                return false;
                            }
                        }
                        
                        // Preparar datos para enviar al backend
                        const formData = {
                            prestamo_id: {{ prestamo.prestamo_id }},
                            numero_cuota: parseInt(selectCuota.value),
                            monto_pagado: parseFloat(inputMonto.value),
                            medio_pago: currentPaymentMethod,
                            fecha_pago: document.querySelector('input[name="fecha_pago"]').value,
                            hora_pago: inputHora.value
                        };
                        
                        // Agregar monto_dado si es efectivo
                        if (currentPaymentMethod === 'EFECTIVO' && inputMontoDado.value) {
                            formData.monto_dado = parseFloat(inputMontoDado.value);
                        }
                        
                        // Deshabilitar botón y mostrar loading
                        const btnSubmit = document.getElementById('btn-submit');
                        btnSubmit.disabled = true;
                        btnSubmitText.textContent = 'Procesando...';
                        
                        try {
                            // Enviar al backend
                            const response = await fetch('/pagos/registrar', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(formData)
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                // Verificar si requiere redirección a Flow (pagos digitales)
                                if (result.requiere_redireccion && result.payment_url) {
                                    // Redirigir al usuario a la pasarela de pago Flow
                                    window.location.href = result.payment_url;
                                } else {
                                    // Pago en efectivo procesado directamente
                                    window.location.href = '/prestamos/{{ prestamo.prestamo_id }}?pago_exitoso=1';
                                }
                            } else {
                                alert('Error al registrar pago: ' + (result.error || 'Error desconocido'));
                                btnSubmit.disabled = false;
                                btnSubmitText.textContent = 'Registrar Pago';
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexión con el servidor');
                            btnSubmit.disabled = false;
                            btnSubmitText.textContent = 'Registrar Pago';
                        }
                    });
                }
                actualizarInputConCuota();
            }

            paymentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    actualizarMetodoPago(this.value);
                    
                    // Aceptar tanto 'TARJETA_CREDITO' como 'TARJETA' por compatibilidad
                    if (this.value === 'TARJETA_CREDITO' || this.value === 'TARJETA') {
                        cardContainer.classList.remove('hidden');
                        cardInputs.forEach(input => input.required = true);
                        if(btnSubmitText) btnSubmitText.textContent = "Pagar con Tarjeta";
                        if(btnSubmitIcon) btnSubmitIcon.className = "fa-solid fa-lock";
                    } else {
                        cardContainer.classList.add('hidden');
                        cardInputs.forEach(input => input.required = false);
                        if(btnSubmitText) btnSubmitText.textContent = "Registrar Pago";
                        if(btnSubmitIcon) btnSubmitIcon.className = "fa-regular fa-paper-plane";
                    }
                });
            });

            actualizarMetodoPago('EFECTIVO');

            document.getElementById('card_number')?.addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, '').match(/.{1,4}/g)?.join(' ') || e.target.value.replace(/\D/g, ''); });
            document.getElementById('card_expiry')?.addEventListener('input', e => { let v = e.target.value.replace(/\D/g, ''); if (v.length >= 3) v = v.substring(0, 2) + '/' + v.substring(2, 4); e.target.value = v; });
        });
    </script>

    
    {% endif %}

</div>
{% endblock %}